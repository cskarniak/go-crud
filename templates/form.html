<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>
    {{ if eq .Mode "new" }}
      {{ index .Entity.Fiche.Titles "create" }}
    {{ else }}
      {{ index .Entity.Fiche.Titles "update" }}
    {{ end }}
  </title>
  <!-- CSS global Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- CSS global des fiches -->
  <link href="/assets/css/fiche/form.css" rel="stylesheet">
  <!-- CSS d'override spécifique à cette fiche -->
  <link href="/assets/css/fiche/{{ .Entity.Fiche.Name }}-overrides.css" rel="stylesheet">
  <!-- CSS global des popups -->
  <link href="/assets/css/popup/popup.css" rel="stylesheet">
  <!-- CSS d'override spécifique à la popup de cette fiche -->
  <link href="/assets/css/popup/{{ .Entity.Fiche.Name }}-overrides.css" rel="stylesheet">
</head>
<body style="background-color: {{ with .Entity.Fiche.PageBackgroundColor }}{{ . }}{{ else }}#f8f9fa{{ end }};">
  {{- $width := "800px" -}}
  {{- if .Entity.Fiche.Width }}{{ $width = .Entity.Fiche.Width }}{{ end -}}
  {{- $maxWidth := "100%" -}}
  {{- if .Entity.Fiche.MaxWidth }}{{ $maxWidth = .Entity.Fiche.MaxWidth }}{{ end -}}
  {{- $bgColor := "white" -}}
  {{- if .Entity.Fiche.FormBackgroundColor }}{{ $bgColor = .Entity.Fiche.FormBackgroundColor }}{{ end -}}
  <div class="card form-card shadow-sm mt-4"
       style="width: {{ $width }}; max-width: {{ $maxWidth }}; background-color: {{ $bgColor }};">
    <div class="card-header bg-primary text-white py-2">
      <h5 class="mb-0 text-center">
        {{ if eq .Mode "new" }}
          {{ index .Entity.Fiche.Titles "create" }}
        {{ else }}
          {{ index .Entity.Fiche.Titles "update" }}
        {{ end }}
      </h5>
    </div>
    <div class="card-body">
      <!-- Affichage des erreurs de validation -->
      {{ if .Errors }}
        <div class="alert alert-danger">
          {{ range $field, $message := .Errors }}
            <div>[{{ $field }}] : {{ $message }}</div>
          {{ end }}
        </div>
      {{ end }}

      <form method="post" action='{{ if eq .Mode "new" }}
                  /{{ .Entity.Fiche.Name }}?page={{ .Page }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}
                {{ else }}
                  /{{ .Entity.Fiche.Name }}/update/{{ index $.DataRow "id" }}?page={{ .Page }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}
                {{ end }}'
            style="--label-col-width: {{ with .Entity.Fiche.LabelColumnWidth }}{{ . }}{{ else }}25%{{ end }};
                   --form-action-button-font-size: {{ with .Entity.Fiche.FormActionButtonsFontSize }}{{ . }}{{ else }}1rem{{ end }};
                   --form-content-max-height-adjustment: {{ with .Entity.Fiche.FormContentMaxHeightAdjustment }}{{ . }}{{ else }}200px{{ end }};">

        <!-- Navigation des onglets -->
        <ul class="nav nav-tabs" id="formTab" role="tablist"
            style="--tab-inactive-bg: {{ with .Entity.Fiche.TabInactiveBackgroundColor }}{{ . }}{{ else }}#e9ecef{{ end }};
                   --tab-active-bg: {{ with .Entity.Fiche.TabActiveBackgroundColor }}{{ . }}{{ else }}#ffffff{{ end }};
                   --tab-content-bg: {{ with .Entity.Fiche.TabContentBackgroundColor }}{{ . }}{{ else }}#ffffff{{ end }};
                   --tab-label-font-size: {{ with .Entity.Fiche.TabLabelFontSize }}{{ . }}{{ else }}1rem{{ end }};">
          {{ range $index, $group := .Entity.Fiche.Groups }}
            <li class="nav-item" role="presentation">
              <button class="nav-link {{ if eq $index 0 }}active{{ end }}" id="tab-{{ $index }}-tab" data-bs-toggle="tab" data-bs-target="#tab-{{ $index }}" type="button" role="tab" aria-controls="tab-{{ $index }}" aria-selected="{{ if eq $index 0 }}true{{ else }}false{{ end }}">{{ .Name }}</button>
            </li>
          {{ end }}
        </ul>

        <!-- Contenu des onglets -->
        <div class="tab-content" id="formTabContent">
          {{ range $groupIndex, $group := .Entity.Fiche.Groups }}
            <div class="tab-pane fade {{ if eq $groupIndex 0 }}show active{{ end }}" id="tab-{{ $groupIndex }}" role="tabpanel" aria-labelledby="tab-{{ $groupIndex }}-tab">
              
              {{ range $fieldIndex, $formField := .Fields }}
                {{ $fieldDef := (index $.Entity.FieldsByName $formField.Name) }}

                {{ if $fieldDef }}
                  <div class="row mb-3 align-items-center {{ if eq $fieldIndex 0 }}mt-4{{ end }}">
                    <label for="{{ $formField.Name }}" class="label-col col-form-label fw-bold">
                      {{ $fieldDef.Label }}
                    </label>
                    <div class="field-col">

                      {{ $isReadOnly := or $fieldDef.ReadOnly $formField.ReadOnly }}

                      {{ if eq $formField.Type "combo_base" }}
                        <!-- combo_base input -->
                        <select id="{{ $formField.Name }}" name="{{ $formField.Name }}" class="form-select{{ if index $.Errors $formField.Name }} is-invalid{{ end }}" {{ if $isReadOnly }}disabled{{ end }} {{ if $.Code }}{{ with index $.Code.FrontValidations $formField.Name }}{{ if .Required }} required{{ end }}{{ end }}{{ end }}>
                          {{ $selectedValue := (printf "%v" (index $.DataRow $formField.Name)) }}
                          {{ range $opt := index $.ComboData $formField.Name }}
                            <option value="{{ $opt.Value }}" {{ if eq (printf "%v" $opt.Value) $selectedValue }}selected{{ end }}>
                              {{ $opt.Label }}
                            </option>
                          {{ end }}
                        </select>

                      {{ else if eq $formField.Type "vision" }}
                        <!-- vision input + modal -->
                        <div class="d-flex">
                          <input type="hidden" id="{{ $formField.Name }}" name="{{ $formField.Name }}" value="{{ index $.DataRow $formField.Name }}">
                          <input type="text" id="{{ $formField.Name }}_display" name="{{ $formField.Name }}_display" readonly class="form-control me-2{{ if index $.Errors $formField.Name }} is-invalid{{ end }}" value="{{ index $.DataRow (print $formField.Name "_display") }}">
                          <button type="button" class="btn btn-outline-secondary vision-button" 
                                    data-bs-toggle="modal" data-bs-target="#modal-{{ $formField.Name }}" {{ if $isReadOnly }}disabled{{ end }}>…</button>
                        </div>

                        <!-- Modal générique vision -->
                        <div class="modal fade vision-modal" id="modal-{{ $formField.Name }}" tabindex="-1">
                          <div class="modal-dialog" style="width: {{ $.PopupConfig.Width }}; max-width: {{ $.PopupConfig.MaxWidth }};">
                            <div class="modal-content" style="max-height: {{ $.PopupConfig.MaxHeight }};">
                              <div class="modal-header" style="background-color: {{ $.PopupConfig.HeaderBackgroundColor }}; color: {{ $.PopupConfig.HeaderTextColor }};">
                                <h5 class="modal-title" style="font-size: {{ $.PopupConfig.TitleFontSize }};">{{ $formField.VisionConfig.ModalTitle }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body" style="background-color: {{ $.PopupConfig.BodyBackgroundColor }}; overflow-y: auto;">
                                <div class="mb-3">
                                  <input type="text" id="search-{{ $formField.Name }}" class="form-control" placeholder="Rechercher…" style="font-size: {{ $.PopupConfig.SearchFontSize }};">
                                </div>
                                <table class="table table-hover vision-table" id="table-{{ $formField.Name }}">
                                  <thead style="font-size: {{ $.PopupConfig.HeaderFontSize }};">
                                    <tr>
                                      {{ range $i, $col := $formField.VisionConfig.DisplayFields }}
                                        <th style="width: {{ index $.PopupConfig.ColumnWidths $i }}; text-align: {{ index $.PopupConfig.ColumnAlignments $i }};">{{ $col }}</th>
                                      {{ end }}
                                      {{ if $.PopupConfig.ShowSelectButton }}
                                        <th style="width: 1%; text-align: center;">Action</th>
                                      {{ end }}
                                    </tr>
                                  </thead>
                                  <tbody></tbody>
                                </table>
                              </div>
                            </div>
                          </div>
                        </div>

                        <script>
                        (function(){
                          const modal = document.getElementById("modal-{{ $formField.Name }}");
                          const displayFields = {{ marshal $formField.VisionConfig.DisplayFields }};
                          const tbody = modal.querySelector("tbody");
                          const searchInput = modal.querySelector("#search-{{ $formField.Name }}");
                          
                          // Récupérer tous les styles directement depuis la configuration
                          const styles = {
                            rowHeight: "{{ $.PopupConfig.RowHeight }}",
                            rowFontSize: "{{ $.PopupConfig.RowFontSize }}",
                            rowFontColor: "{{ $.PopupConfig.RowFontColor }}",
                            evenRowColor: "{{ $.PopupConfig.EvenRowColor }}",
                            oddRowColor: "{{ $.PopupConfig.OddRowColor }}",
                            hoverColor: "{{ $.PopupConfig.TableHoverColor }}",
                            columnAlignments: {{ marshal $.PopupConfig.ColumnAlignments }},
                            showSelectButton: {{ $.PopupConfig.ShowSelectButton }},
                            selectButtonLabel: "{{ $.PopupConfig.SelectButtonLabel }}"
                          };

                          function selectRow(row) {
                            document.getElementById("{{ $formField.Name }}").value = row["{{ $formField.VisionConfig.ReturnField }}"]; 
                            document.getElementById("{{ $formField.Name }}_display").value = row["{{ $formField.VisionConfig.ReturnFieldDisplay }}"];
                            bootstrap.Modal.getInstance(modal).hide(); 
                          }

                          function populateRows(rows) {
                            tbody.innerHTML = "";
                            rows.forEach((row, index) => {
                              const tr = document.createElement("tr");
                              
                              const originalBgColor = (index % 2 === 0) ? styles.oddRowColor : styles.evenRowColor;
                              
                              displayFields.forEach((col, colIndex) => {
                                const td = document.createElement("td"); 
                                td.textContent = row[col] ?? ""; 
                                
                                // Appliquer TOUS les styles à la CELLULE (TD) avec !important
                                td.style.setProperty('background-color', originalBgColor, 'important');
                                td.style.setProperty('height', styles.rowHeight, 'important');
                                td.style.setProperty('line-height', styles.rowHeight, 'important');
                                td.style.setProperty('font-size', styles.rowFontSize, 'important');
                                td.style.setProperty('color', styles.rowFontColor, 'important');
                                td.style.setProperty('padding', '0 0.5rem', 'important');
                                td.style.setProperty('text-align', styles.columnAlignments[colIndex], 'important');

                                tr.appendChild(td);
                              });
                              
                              // Ajouter la cellule du bouton si activé
                              if (styles.showSelectButton) {
                                const tdButton = document.createElement("td");
                                tdButton.style.setProperty('background-color', originalBgColor, 'important');
                                tdButton.style.setProperty('text-align', 'center', 'important');
                                const button = document.createElement("button");
                                button.type = "button";
                                button.className = "btn btn-primary btn-sm";
                                button.textContent = styles.selectButtonLabel;
                                button.onclick = (e) => {
                                  e.stopPropagation(); // Empêche le clic de se propager à la ligne
                                  selectRow(row);
                                };
                                tdButton.appendChild(button);
                                tr.appendChild(tdButton);
                              }
                              
                              tr.style.cursor = "pointer";
                              tr.onclick = () => selectRow(row);

                              // Gérer le survol en modifiant toutes les cellules de la ligne
                              tr.onmouseover = () => { 
                                tr.querySelectorAll('td').forEach(td => td.style.setProperty('background-color', styles.hoverColor, 'important'));
                              };
                              tr.onmouseout = () => { 
                                tr.querySelectorAll('td').forEach(td => td.style.setProperty('background-color', originalBgColor, 'important'));
                              };

                              tbody.appendChild(tr);
                            });
                          }

                          function filterRows(term) {
                            const filter = term.trim().toLowerCase();
                            tbody.querySelectorAll("tr").forEach(tr => {
                              const text = Array.from(tr.cells).map(td => td.textContent.toLowerCase()).join(" ");
                              tr.style.display = (filter === "" || text.includes(filter)) ? "" : "none";
                            });
                          }

                          modal.addEventListener("shown.bs.modal", () => {
                            fetch("/{{ $.Entity.Fiche.Name }}/vision-data/{{ $formField.Name }}")
                              .then(r => r.json())
                              .then(rows => { populateRows(rows); searchInput.value = ""; filterRows(""); searchInput.focus(); })
                              .catch(console.error);
                          });

                          searchInput.addEventListener("input", e => filterRows(e.target.value));
                        })();
                        </script>
                      
                      {{ else if eq $fieldDef.Type "boolean" }}
                        {{/* Input pour les champs booléens */}}
                        <div class="form-check mt-2">
                          <input class="form-check-input" type="checkbox" id="{{ $formField.Name }}" name="{{ $formField.Name }}"
                            {{- if index $.DataRow $formField.Name }} checked{{ end }}
                            {{- if $isReadOnly }} disabled{{ end }}>
                        </div>
                      
                      {{ else if and (eq $fieldDef.Type "string") (gt $fieldDef.MaxLength 50) }}
                        {{/* Textarea pour les champs de texte longs */}}
                        {{- $rows := 3 -}}
                        {{- if gt $formField.Rows 0 }}{{ $rows = $formField.Rows }}{{ end -}}
                        <textarea id="{{ $formField.Name }}" name="{{ $formField.Name }}" class="form-control{{ if index $.Errors $formField.Name }} is-invalid{{ end }}{{ if $isReadOnly }} bg-light{{ end }}"
                          rows="{{ $rows }}"
                          {{- if $isReadOnly }} readonly{{ end }}
                          {{- if gt $fieldDef.MaxLength 0 }} maxlength="{{ $fieldDef.MaxLength }}"{{ end }}
                          >{{- index $.DataRow $formField.Name -}}</textarea>

                      {{ else }}
                        {{/* Input pour les autres types de champs */}}
                        <div class="input-group">
                          {{- /* Préparation des classes et attributs */ -}}
                          {{- $alignClass := "" -}}
                          {{- if eq $formField.Align "right" }}{{ $alignClass = " text-end" }}
                          {{- else if eq $formField.Align "center" }}{{ $alignClass = " text-center" }}
                          {{- else if eq $formField.Align "left" }}{{ $alignClass = " text-start" }}
                          {{- end -}}
                          {{- $errorClass := "" -}}
                          {{- if index $.Errors $formField.Name }}{{- $errorClass = " is-invalid" -}}{{ end -}}
                          {{- $readOnlyClass := "" -}}
                          {{- if $isReadOnly }}{{- $readOnlyClass = " bg-light" -}}{{ end -}}
                          {{- $finalClasses := printf "form-control%s%s%s" $errorClass $alignClass $readOnlyClass -}}

                          <input type="text" id="{{ $formField.Name }}" name="{{ $formField.Name }}" class="{{ $finalClasses }}" value="{{ index $.DataRow $formField.Name }}"
                            {{- if $isReadOnly }} readonly{{ end }}
                            {{- if gt $formField.MaxLength 0 }} maxlength="{{ $formField.MaxLength }}"
                            {{- else if gt $fieldDef.MaxLength 0 }} maxlength="{{ $fieldDef.MaxLength }}"{{ end }}
                            {{- if gt $formField.Size 0 }} size="{{ $formField.Size }}"{{ end }}
                            {{- if $.Code }}{{ with index $.Code.FrontValidations $formField.Name }}
                              {{- if .Required }} required{{ end }}
                              {{- if .Pattern }} pattern="{{ .Pattern }}" title="{{ .Title }}"{{ end }}
                            {{- end }}{{ end }}>
                          
                          {{ if $formField.VisionButton }}
                            <button type="button" class="btn btn-outline-secondary vision-button" 
                                    data-vision-form="{{ $formField.VisionButton }}"
                                    data-field-name="{{ $formField.Name }}">
                              ...
                            </button>
                          {{ end }}
                        </div>
                      {{ end }}

                      {{ with index $.Errors $formField.Name }}<div class="invalid-feedback">{{ . }}</div>{{ end }}

                    </div>
                  </div>
                {{ end }}
              {{ end }}
            </div>
          {{ end }}
        </div>

        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-success">{{ if eq .Mode "new" }}{{ index .Entity.Fiche.ButtonLabels "submitCreate" }}{{ else }}{{ index .Entity.Fiche.ButtonLabels "submitUpdate" }}{{ end }}</button>
          <a href="/{{ .Entity.List.Name }}?page={{ .Page }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}" class="btn btn-secondary ms-2">{{ index .Entity.Fiche.ButtonLabels "cancel" }}</a>
        </div>

      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
