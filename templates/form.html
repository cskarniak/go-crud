<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>
    {{ if eq .Mode "new" }}
      {{ index .Entity.Fiche.Labels "titleCreate" }}
    {{ else }}
      {{ index .Entity.Fiche.Labels "titleUpdate" }}
    {{ end }}
  </title>
  <!-- CSS global Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- CSS global des fiches -->
  <link href="/assets/css/fiche/form.css" rel="stylesheet">
  <!-- CSS d'override sp√©cifique √† cette fiche -->
  <link href="/assets/css/fiche/{{ .Entity.Fiche.Name }}-overrides.css" rel="stylesheet">
  <!-- CSS global des popups -->
  <link href="/assets/css/popup/popup.css" rel="stylesheet">
  <!-- CSS d'override sp√©cifique √† la popup de cette fiche -->
  <link href="/assets/css/popup/{{ .Entity.Fiche.Name }}-overrides.css" rel="stylesheet">
</head>
<body>
  <div class="card form-card shadow-sm mt-4">
    <div class="card-header bg-primary text-white py-2">
      <h5 class="mb-0 text-center">
        {{ if eq .Mode "new" }}
          {{ index .Entity.Fiche.Labels "titleCreate" }}
        {{ else }}
          {{ index .Entity.Fiche.Labels "titleUpdate" }}
        {{ end }}
      </h5>
    </div>
    <div class="card-body">
      <form method="post" action='{{ if eq .Mode "new" }}
                  /{{ .Entity.Fiche.Name }}?page={{ .Page }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}
                {{ else }}
                  /{{ .Entity.Fiche.Name }}/update/{{ index $.DataRow "id" }}?page={{ .Page }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}
                {{ end }}'>

        {{ range .Entity.Fiche.Groups }}
          <fieldset class="mb-4">
            <legend>{{ .Name }}</legend>

            {{ range .Fields }}
              {{ $fd := . }}
              <div class="row mb-3 align-items-center">
                <label for="{{ $fd.Name }}" class="col-sm-3 col-form-label fw-bold">
                  {{ $fd.Name }}
                </label>
                <div class="col-sm-9">

                  {{ if eq $fd.Type "combo_base" }}
                    <!-- combo_base input -->
                    <select id="{{ $fd.Name }}" name="{{ $fd.Name }}" class="form-select{{ if index $.Errors $fd.Name }} is-invalid{{ end }}" {{ if $.Code }}{{ with index $.Code.FrontValidations $fd.Name }}{{ if .Required }} required{{ end }}{{ end }}{{ end }}>
                      {{ range $opt := index $.ComboData $fd.Name }}
                        <option value="{{ $opt.Value }}" {{ if eq (printf "%v" $opt.Value) (printf "%v" (index $.DataRow $fd.Name)) }} selected{{ end }}>{{ $opt.Label }}</option>
                      {{ end }}
                    </select>

                  {{ else if eq $fd.Type "vision" }}
                    <!-- vision input + modal -->
                    <div class="d-flex">
                      <input type="text" id="{{ $fd.Name }}" name="{{ $fd.Name }}" readonly class="form-control me-2{{ if index $.Errors $fd.Name }} is-invalid{{ end }}" value="{{ index $.DataRow $fd.Name }}">
                      <button type="button" class="btn-clode btn-close-whiteoutline-primary" data-bs-toggle="modal" data-bs-target="#modal-{{ $fd.Name }}">‚Ä¶</button>
                    </div>

                    <!-- Modal g√©n√©rique vision -->
                    <div class="modal fade vision-modal" id="modal-{{ $fd.Name }}" tabindex="-1">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title">{{ $fd.VisionConfig.ModalTitle }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            <div class="mb-3">
                              <input type="text" id="search-{{ $fd.Name }}" class="form-control" placeholder="Rechercher‚Ä¶">
                            </div>
                            <table class="table table-hover" id="table-{{ $fd.Name }}">
                              <thead><tr>{{ range $col := $fd.VisionConfig.DisplayFields }}<th>{{ $col }}</th>{{ end }}</tr></thead>
                              <tbody></tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>

                    <script>
                    (function(){
                      const modal = document.getElementById("modal-{{ $fd.Name }}");
                      const displayFields = {{ marshal $fd.VisionConfig.DisplayFields }};
                      const tbody = modal.querySelector("tbody");
                      const searchInput = modal.querySelector("#search-{{ $fd.Name }}");

                      function populateRows(rows) {
                        tbody.innerHTML = "";
                        rows.forEach(row => {
                          const tr = document.createElement("tr");
                          displayFields.forEach(col => {
                            const td = document.createElement("td"); td.textContent = row[col] ?? ""; tr.appendChild(td);
                          });
                          tr.style.cursor = "pointer";
                          tr.onclick = () => { document.getElementById("{{ $fd.Name }}").value = row["{{ $fd.VisionConfig.ReturnField }}"]; bootstrap.Modal.getInstance(modal).hide(); };
                          tbody.appendChild(tr);
                        });
                      }

                      function filterRows(term) {
                        const filter = term.trim().toLowerCase();
                        tbody.querySelectorAll("tr").forEach(tr => {
                          const text = Array.from(tr.cells).map(td => td.textContent.toLowerCase()).join(" ");
                          tr.style.display = (filter === "" || text.includes(filter)) ? "" : "none";
                        });
                      }

                      modal.addEventListener("shown.bs.modal", () => {
                        fetch("/{{ $.Entity.Fiche.Name }}/vision-data/{{ $fd.Name }}")
                          .then(r => r.json())
                          .then(rows => { populateRows(rows); searchInput.value = ""; filterRows(""); searchInput.focus(); })
                          .catch(console.error);
                      });

                      searchInput.addEventListener("input", e => filterRows(e.target.value));
                    })();
                    </script>

                  {{ else }}
                    {{/* V28 - Input group pour potentiellement ajouter un bouton vision */}}
                    <div class="input-group">
                      <input type="text" id="{{ $fd.Name }}" name="{{ $fd.Name }}" class="form-control{{ if index $.Errors $fd.Name }} is-invalid{{ end }}" value="{{ index $.DataRow $fd.Name }}" {{ if $.Code }}{{ with index $.Code.FrontValidations $fd.Name }}{{ if .Required }} required{{ end }}{{ if .Pattern }} pattern="{{ .Pattern }}" title="{{ .Title }}"{{ end }}{{ end }}{{ end }}>
                      
                      {{/* V28 - Ajout du bouton si configur√© dans le YAML */}}
                      {{ if $fd.VisionButton }}
                        <button class="btn btn-outline-secondary vision-button" 
                                type="button"
                                data-vision-form="{{ $fd.VisionButton }}"
                                data-field-name="{{ $fd.Name }}">
                          üëÅÔ∏è
                        </button>
                      {{ end }}
                    </div>
                  {{ end }}

                  {{ with index $.Errors $fd.Name }}<div class="invalid-feedback">{{ . }}</div>{{ end }}

                </div>
              </div>
            {{ end }}
          </fieldset>
        {{ end }}

        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-success">{{ if eq .Mode "new" }}{{ index .Entity.Fiche.Labels "submitCreate" }}{{ else }}{{ index .Entity.Fiche.Labels "submitUpdate" }}{{ end }}</button>
          <a href="/{{ .Entity.List.Name }}?page={{ .Page }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}" class="btn btn-secondary ms-2">{{ index .Entity.Fiche.Labels "cancel" }}</a>
        </div>

      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  {{/* V28 - Script pour g√©rer les boutons vision */}}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const visionButtons = document.querySelectorAll('.vision-button');

      visionButtons.forEach(button => {
        button.addEventListener('click', function() {
          const formName = this.dataset.visionForm;
          const fieldName = this.dataset.fieldName;
          const inputElement = document.getElementById(fieldName);

          if (!inputElement) {
            console.error('Champ de formulaire associ√© non trouv√© pour le bouton vision :', fieldName);
            return;
          }

          const fieldValue = inputElement.value;

          if (!fieldValue) {
            alert("Veuillez d'abord saisir une valeur dans le champ.");
            return;
          }

          // Ajout du param√®tre `return_to` pour indiquer au popup quel champ mettre √† jour.
          const url = `/vision/${formName}?${fieldName}=${encodeURIComponent(fieldValue)}&return_to=${fieldName}`;

          window.open(url, '_blank');
        });
      });
    });
  </script>
</body>
</html>
