<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>
    {{ if eq .Mode "new" }}
      {{ index .Entity.Fiche.Labels "titleCreate" }}
    {{ else }}
      {{ index .Entity.Fiche.Labels "titleUpdate" }}
    {{ end }}
  </title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet">
  <link href="/assets/css/form.css" rel="stylesheet">
</head>
<body>
  <div class="card form-card shadow-sm mt-4">
    <div class="card-header bg-primary text-white py-2">
      <h5 class="mb-0 text-center">
        {{ if eq .Mode "new" }}
          {{ index .Entity.Fiche.Labels "titleCreate" }}
        {{ else }}
          {{ index .Entity.Fiche.Labels "titleUpdate" }}
        {{ end }}
      </h5>
    </div>
    <div class="card-body">
      <form
        method="post"
        action="{{ if eq .Mode "new" -}}
                  /{{ .Entity.Fiche.Name }}?page={{ .Page }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}
                {{- else -}}
                  /{{ .Entity.Fiche.Name }}/update/{{ index .DataRow "id" }}?page={{ .Page }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}
                {{- end }}">

        {{/* Parcours des groupes */}}
        {{ range .Entity.Fiche.Groups }}
          <fieldset class="mb-4">
            <legend>{{ .Name }}</legend>

            {{/* Parcours des champs dans le groupe */}}
            {{ range .Fields }}
              {{ $fd := . }}
              <div class="row mb-3 align-items-center">
                <label for="{{ $fd.Name }}" class="col-sm-3 col-form-label fw-bold">
                  {{ $fd.Name }}
                </label>
                <div class="col-sm-9">

                  {{/* --- combo_base --- */}}
                  {{ if eq $fd.Type "combo_base" }}
                    <select
                      id="{{ $fd.Name }}"
                      name="{{ $fd.Name }}"
                      class="form-select{{ if index $.Errors $fd.Name }} is-invalid{{ end }}"
                      {{ with index $.Code.FrontValidations $fd.Name }}
                        {{ if .Required }} required{{ end }}
                      {{ end }}>
                      {{ range $opt := index $.ComboData $fd.Name }}
                        <option
                          value="{{ $opt.Value }}"
                          {{ if eq (printf "%v" $opt.Value) (printf "%v" (index $.DataRow $fd.Name)) }}
                            selected
                          {{ end }}>
                          {{ $opt.Label }}
                        </option>
                      {{ end }}
                    </select>

                  {{/* --- vision --- */}}
                  {{ else if eq $fd.Type "vision" }}
                    <div class="d-flex">
                      <input
                        type="text"
                        id="{{ $fd.Name }}"
                        name="{{ $fd.Name }}"
                        readonly
                        class="form-control me-2{{ if index $.Errors $fd.Name }} is-invalid{{ end }}"
                        value="{{ index $.DataRow $fd.Name }}">
                      <button
                        type="button"
                        class="btn btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#modal-{{ $fd.Name }}">
                        â€¦
                      </button>
                    </div>

                    {{/* Modal Bootstrap */}}
                    <div class="modal fade" id="modal-{{ $fd.Name }}" tabindex="-1">
                      <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title">{{ $fd.VisionConfig.ModalTitle }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            <table class="table table-hover" id="table-{{ $fd.Name }}">
                              <thead>
                                <tr>
                                  {{ range $col := $fd.VisionConfig.DisplayFields }}
                                    <th>{{ $col }}</th>
                                  {{ end }}
                                </tr>
                              </thead>
                              <tbody></tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>

                    <script>
                      (function(){
                        const modal = document.getElementById("modal-{{ $fd.Name }}");
                        const displayFields = {{ marshal $fd.VisionConfig.DisplayFields }};
                        modal.addEventListener("show.bs.modal", () => {
                          fetch("/{{ $.Entity.Fiche.Name }}/vision-data/{{ $fd.Name }}")
                            .then(r => r.json())
                            .then(rows => {
                              console.log("VISION displayFields:", displayFields);
                              console.log("VISION rows:", rows);

                              const tbody = modal.querySelector("tbody");
                              tbody.innerHTML = "";
                              rows.forEach(row => {
                                const tr = document.createElement("tr");
                                displayFields.forEach(col => {
                                  const td = document.createElement("td");
                                  td.textContent = row[col] ?? "";
                                  tr.appendChild(td);
                                });
                                tr.style.cursor = "pointer";
                                tr.onclick = () => {
                                  document.getElementById("{{ $fd.Name }}").value =
                                    row["{{ $fd.VisionConfig.ReturnField }}"];
                                  bootstrap.Modal.getInstance(modal).hide();
                                };
                                tbody.appendChild(tr);
                              });
                            });
                        });
                      })();
                    </script>

                  {{/* --- autre champ texte --- */}}
                  {{ else }}
                    <input
                      type="text"
                      id="{{ $fd.Name }}"
                      name="{{ $fd.Name }}"
                      class="form-control{{ if index $.Errors $fd.Name }} is-invalid{{ end }}"
                      value="{{ index $.DataRow $fd.Name }}"
                      {{ with index $.Code.FrontValidations $fd.Name }}
                        {{ if .Required }} required{{ end }}
                        {{ if .Pattern }} pattern="{{ .Pattern }}" title="{{ .Title }}"{{ end }}
                      {{ end }}>
                  {{ end }}

                  {{/* Affichage inline des erreurs back-end */}}
                  {{ with index $.Errors $fd.Name }}
                    <div class="invalid-feedback">{{ . }}</div>
                  {{ end }}

                </div>
              </div>
            {{ end }}

          </fieldset>
        {{ end }}

        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-success">
            {{ if eq .Mode "new" }}
              {{ index .Entity.Fiche.Labels "submitCreate" }}
            {{ else }}
              {{ index .Entity.Fiche.Labels "submitUpdate" }}
            {{ end }}
          </button>
          <a
            href="/{{ .Entity.List.Name }}?page={{ .Page }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}"
            class="btn btn-secondary ms-2">
            {{ index .Entity.Fiche.Labels "cancel" }}
          </a>
        </div>

      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
