<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>{{ .Entity.LabelPlural }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/css/style.css" rel="stylesheet">
  <link href="/assets/css/list/list.css" rel="stylesheet">
  {{ if .Entity.List.Name }}
  <link href="/assets/css/list/{{ .Entity.List.Name }}-overrides.css" rel="stylesheet">
  {{ end }}
</head>
<body>

  <div class="list-card">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h2 class="mb-0">
          {{- /* Le titre vient de la config Vision si elle existe, sinon de la config List */ -}}
          {{- if .VisionConfig -}}
            {{- with index .VisionConfig.Labels "title" }}{{ . }}{{ else }}{{ .Entity.LabelPlural }}{{ end -}}
          {{- else -}}
            {{- with index .Entity.List.Labels "title" }}{{ . }}{{ else }}{{ .Entity.LabelPlural }}{{ end -}}
          {{- end -}}
        </h2>
      </div>
      <div class="card-body">

        <form method="get" class="toolbar mb-3">
          <button type="button" class="btn btn-secondary">Menu</button>
          
          {{- /* Définir les permissions par défaut (tout autoriser pour la liste standard) */ -}}
          {{- $allowCreate := true -}}
          {{- if .VisionConfig -}}
            {{- $allowCreate = .VisionConfig.Actions.AllowCreate -}}
          {{- end -}}

          {{- if $allowCreate -}}
          <a href="/{{ .Entity.Fiche.Name }}/new?page={{ .Page }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}" class="btn btn-success">Nouveau</a>
          {{- end -}}

          {{- /* V29 - Bouton de retour pour les fenêtres vision */ -}}
          {{ if .VisionConfig }}
            <button type="button" id="vision-close-btn" class="btn btn-warning ms-2">Retour</button>
          {{ end }}

          {{- /* La barre de recherche n'est affichée que pour les listes standard */ -}}
          {{- if not .VisionConfig }}
          <div class="ms-auto d-flex align-items-center gap-2">
            <label class="mb-0">Afficher</label>
            <select name="pageSize" class="form-select form-select-sm" style="width:auto" onchange="this.form.submit()">
              {{ range .PageSizeOptions }}
                <option value="{{ . }}"{{ if eq $.PageSize . }} selected{{ end }}>{{ . }}</option>
              {{ end }}
            </select>

            <input type="hidden" name="sort"  value="{{ .SortField }}">
            <input type="hidden" name="order" value="{{ .SortOrder }}">

            <input type="text" name="search" class="form-control form-control-sm" placeholder="Recherche…" value="{{ .Search }}" style="width:200px;">
            <button type="submit" class="btn btn-primary btn-sm">Go</button>
            <a href="?page=1&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}" class="btn btn-outline-secondary btn-sm">Clear</a>
          </div>
          {{- end }}
        </form>

        <div class="table-responsive">
          <table class="table table-hover table-striped table-fixed table-bordered mb-0">
            <thead class="table-light">
              <tr>
                {{ range .Columns }}
                  <th scope="col">
                    <a href="?page=1&pageSize={{ $.PageSize }}&sort={{ . }}&order={{ if and (eq $.SortField .) (eq $.SortOrder "asc") }}desc{{ else }}asc{{ end }}&search={{ $.Search }}" class="link-dark text-decoration-none">
                      {{ . }}
                      {{ if eq $.SortField . }}{{ if eq $.SortOrder "asc" }}▲{{ else }}▼{{ end }}{{ end }}
                    </a>
                  </th>
                {{ end }}
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              {{- /* Définir les permissions pour les lignes (par défaut à true) */ -}}
              {{- $allowUpdate := true -}}
              {{- $allowDelete := true -}}
              {{- if .VisionConfig -}}
                {{- $allowUpdate = .VisionConfig.Actions.AllowUpdate -}}
                {{- $allowDelete = .VisionConfig.Actions.AllowDelete -}}
              {{- end -}}

              {{ range .Data }}
                {{ $row := . }}
                <tr data-id="{{ index $row "id" }}" class="{{ if and $.IsVisionReturn $.AllowSelectable }}vision-return-row{{ end }} {{ if index $row "_highlight" }}highlight-row{{ end }}">
                  {{ range $.Columns }}
                    {{ $currentColumnName := . }}
                    {{ $alignClass := "" }}
                    {{ range $.Entity.Fields }}
                        {{ if eq .Name $currentColumnName }}
                            {{ if .Align }}
                                {{ $alignClass = printf "text-%s" .Align }}
                            {{ end }}
                        {{ end }}
                    {{ end }}
                    <td data-label="{{ . }}" class="{{ $alignClass }}">{{ index $row . }}</td>
                  {{ end }}
                  <td>
                    {{- if $allowUpdate -}}
                    <a href="/{{ $.Entity.Fiche.Name }}/edit/{{ index $row "id" }}?page={{ $.Page }}&pageSize={{ $.PageSize }}&sort={{ $.SortField }}&order={{ $.SortOrder }}" class="btn btn-sm btn-primary me-1">Éditer</a>
                    {{- end -}}
                    {{- if $allowDelete -}}
                    <button type="button" class="btn btn-sm btn-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmDeleteModal"
                            data-delete-url="/{{ $.Entity.Fiche.Name }}/delete/{{ index $row "id" }}">
                      Supprimer
                    </button>
                    {{- end -}}
                  </td>
                </tr>
              {{ end }}
            </tbody>
          </table>
        </div>

        {{ if gt .TotalPages 1 }}
          <nav aria-label="Pagination" class="mt-3">
            <ul class="pagination justify-content-center mb-0">
              <li class="page-item{{ if eq .Page 1 }} disabled{{ end }}">
                <a class="page-link" href="?page={{ sub .Page 1 }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}&search={{ .Search }}">Précédent</a>
              </li>
              <li class="page-item disabled mx-2 align-self-center">Page {{ .Page }} sur {{ .TotalPages }}</li>
              <li class="page-item{{ if eq .Page .TotalPages }} disabled{{ end }}">
                <a class="page-link" href="?page={{ add .Page 1 }}&pageSize={{ .PageSize }}&sort={{ .SortField }}&order={{ .SortOrder }}&search={{ .Search }}">Suivant</a>
              </li>
            </ul>
          </nav>
        {{ end }}

      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmer la suppression</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Êtes-vous sûr de vouloir supprimer cet enregistrement ? Cette action est irréversible.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <form id="deleteForm" method="post" action="">
            <button type="submit" class="btn btn-danger">Confirmer la suppression</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Logique pour la confirmation de suppression
      const confirmDeleteModal = document.getElementById('confirmDeleteModal');
      if (confirmDeleteModal) {
        confirmDeleteModal.addEventListener('show.bs.modal', function (event) {
          const button = event.relatedTarget;
          const deleteUrl = button.getAttribute('data-delete-url');
          const deleteForm = confirmDeleteModal.querySelector('#deleteForm');
          deleteForm.setAttribute('action', deleteUrl);
        });
      }

      // Logique pour le retour de valeur depuis une fenêtre vision
      const isVisionReturn = {{ .IsVisionReturn }};
      const allowSelectable = {{ .AllowSelectable }};

      if (isVisionReturn && allowSelectable) {
        const returnToField = '{{ .ReturnTo }}';
        const rows = document.querySelectorAll('.vision-return-row');

        rows.forEach(row => {
          row.style.cursor = 'pointer';
          row.addEventListener('click', function() {
            const selectedId = this.dataset.id;

            if (window.opener && !window.opener.closed) {
              const targetInput = window.opener.document.getElementById(returnToField);
              if (targetInput) {
                targetInput.value = selectedId;
                window.close();
              } else {
                alert('Erreur: Impossible de trouver le champ de destination.');
              }
            } else {
              alert('Erreur: Impossible de trouver la fenêtre d\'origine.');
            }
          });
        });
      }

      // V29 - Logique pour le bouton de retour/fermeture des fenêtres vision
      const visionCloseBtn = document.getElementById('vision-close-btn');
      if (visionCloseBtn) {
        visionCloseBtn.addEventListener('click', function() {
          window.close();
        });
      }
    });
  </script>

</body>
</html>
